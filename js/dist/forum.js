(()=>{var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{"use strict";e.r(t);const n=flarum.core.compat["forum/app"];var r=e.n(n);const o=flarum.core.compat["common/extend"],a=flarum.core.compat["forum/utils/DiscussionControls"];var i=e.n(a);const s=flarum.core.compat["forum/utils/PostControls"];var l=e.n(s);const c=flarum.core.compat["common/components/Button"];var u=e.n(c);const d="p".charCodeAt(0),f="H".charCodeAt(0),g="Y".charCodeAt(0),h="s".charCodeAt(0);let p;function w(e,t,n=!1){const r=new Uint8Array(13);t*=39.3701,r[0]=d,r[1]=f,r[2]=g,r[3]=h,r[4]=t>>>24,r[5]=t>>>16,r[6]=t>>>8,r[7]=255&t,r[8]=r[4],r[9]=r[5],r[10]=r[6],r[11]=r[7],r[12]=1;const o=function(e){let t=-1;p||(p=function(){const e=new Int32Array(256);for(let t=0;t<256;t++){let n=t;for(let e=0;e<8;e++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n}return e}());for(let n=0;n<e.length;n++)t=p[255&(t^e[n])]^t>>>8;return-1^t}(r),a=new Uint8Array(4);if(a[0]=o>>>24,a[1]=o>>>16,a[2]=o>>>8,a[3]=255&o,n){const t=function(e){for(let t=e.length-1;t>=4;t--)if(9===e[t-4]&&e[t-3]===d&&e[t-2]===f&&e[t-1]===g&&e[t]===h)return t-3;return 0}(e);return e.set(r,t),e.set(a,t+13),e}{const t=new Uint8Array(4);t[0]=0,t[1]=0,t[2]=0,t[3]=9;const n=new Uint8Array(54);return n.set(e,0),n.set(t,33),n.set(r,37),n.set(a,50),n}}const y="AAlwSFlz",b="AAAJcEhZ",v="AAAACXBI",S="[modern-screenshot]",C="undefined"!=typeof window,E=C&&"Worker"in window,A=C&&"atob"in window,x=C&&"btoa"in window,N=C?window.navigator?.userAgent:"",k=N.includes("Chrome"),D=N.includes("AppleWebKit")&&!k,T=N.includes("Firefox"),P=e=>e&&"__CONTEXT__"in e,F=e=>"CSSFontFaceRule"===e.constructor.name,$=e=>"CSSImportRule"===e.constructor.name,I=e=>1===e.nodeType,_=e=>"object"==typeof e.className,R=e=>"image"===e.tagName,M=e=>"use"===e.tagName,L=e=>I(e)&&void 0!==e.style&&!_(e),U=e=>8===e.nodeType,B=e=>3===e.nodeType,j=e=>"IMG"===e.tagName,q=e=>"VIDEO"===e.tagName,W=e=>"CANVAS"===e.tagName,O=e=>"TEXTAREA"===e.tagName,z=e=>"INPUT"===e.tagName,V=e=>"STYLE"===e.tagName,H=e=>"SCRIPT"===e.tagName,X=e=>"SELECT"===e.tagName,Y=e=>"SLOT"===e.tagName,G=e=>"IFRAME"===e.tagName,J=(...e)=>console.warn(S,...e);function K(e){const t=e?.createElement?.("canvas");return t&&(t.height=t.width=1),Boolean(t)&&"toDataURL"in t&&Boolean(t.toDataURL("image/webp").includes("image/webp"))}const Q=e=>e.startsWith("data:");function Z(e,t){if(e.match(/^[a-z]+:\/\//i))return e;if(C&&e.match(/^\/\//))return window.location.protocol+e;if(e.match(/^[a-z]+:/i))return e;if(!C)return e;const n=ee().implementation.createHTMLDocument(),r=n.createElement("base"),o=n.createElement("a");return n.head.appendChild(r),n.body.appendChild(o),t&&(r.href=t),o.href=e,o.href}function ee(e){return(e&&I(e)?e?.ownerDocument:e)??window.document}const te="http://www.w3.org/2000/svg";const ne=e=>function(e,t){return new Promise(((n,r)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=()=>r(o.error),o.onabort=()=>r(new Error(`Failed read blob to ${t}`)),"dataUrl"===t?o.readAsDataURL(e):"arrayBuffer"===t&&o.readAsArrayBuffer(e)}))}(e,"dataUrl");function re(e,t){const n=ee(t).createElement("img");return n.decoding="sync",n.loading="eager",n.src=e,n}function oe(e,t){return new Promise((n=>{const{timeout:r,ownerDocument:o,onError:a,onWarn:i}=t??{},s="string"==typeof e?re(e,ee(o)):e;let l=null,c=null;function u(){n(s),l&&clearTimeout(l),c?.()}if(r&&(l=setTimeout(u,r)),q(s)){const e=s.currentSrc||s.src;if(!e)return s.poster?oe(s.poster,t).then(n):u();if(s.readyState>=2)return u();const r=u,o=t=>{i?.("Failed video load",e,t),a?.(t),u()};c=()=>{s.removeEventListener("loadeddata",r),s.removeEventListener("error",o)},s.addEventListener("loadeddata",r,{once:!0}),s.addEventListener("error",o,{once:!0})}else{const e=R(s)?s.href.baseVal:s.currentSrc||s.src;if(!e)return u();const t=async()=>{if(j(s)&&"decode"in s)try{await s.decode()}catch(t){i?.("Failed to decode image, trying to render anyway",s.dataset.originalSrc||e,t)}u()},n=t=>{i?.("Failed image load",s.dataset.originalSrc||e,t),u()};if(j(s)&&s.complete)return t();c=()=>{s.removeEventListener("load",t),s.removeEventListener("error",n)},s.addEventListener("load",t,{once:!0}),s.addEventListener("error",n,{once:!0})}}))}const ae=function(){let e=0;return()=>(e+=1,`u${`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4)}${e}`)}();function ie(e){return e?.split(",").map((e=>e.trim().replace(/"|'/g,"").toLowerCase())).filter(Boolean)}function se(e){return{time:t=>e&&console.time(`${S} ${t}`),timeEnd:t=>e&&console.timeEnd(`${S} ${t}`),warn:(...t)=>e&&J(...t)}}async function le(e,t){return P(e)?e:async function(e,t){const{scale:n=1,workerUrl:r,workerNumber:o=1}=t||{},a=Boolean(t?.debug),i=t?.features??!0,s=e.ownerDocument??(C?window.document:void 0),l=e.ownerDocument?.defaultView??(C?window:void 0),c=new Map,u={width:0,height:0,quality:1,type:"image/png",scale:n,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:a,fetch:{requestInit:(d=t?.fetch?.bypassingCache,{cache:d?"no-cache":"force-cache"}),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1,...t?.fetch},fetchFn:null,font:{},drawImageInterval:100,workerUrl:null,workerNumber:o,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,includeStyleProperties:null,autoDestruct:!1,...t,__CONTEXT__:!0,log:se(a),node:e,ownerDocument:s,ownerWindow:l,dpi:1===n?null:96*n,svgStyleElement:ce(s),svgDefsElement:s?.createElementNS(te,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...Array.from({length:E&&r&&o?o:0})].map((()=>{try{const e=new Worker(r);return e.onmessage=async e=>{const{url:t,result:n}=e.data;n?c.get(t)?.resolve?.(n):c.get(t)?.reject?.(new Error(`Error receiving message from worker: ${t}`))},e.onmessageerror=e=>{const{url:t}=e.data;c.get(t)?.reject?.(new Error(`Error receiving message from worker: ${t}`))},e}catch(e){return u.log.warn("Failed to new Worker",e),null}})).filter(Boolean),fontFamilies:new Map,fontCssTexts:new Map,acceptOfImage:`${[K(s)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:c,drawImageCount:0,tasks:[],features:i,isEnable:e=>"restoreScrollPosition"===e?"boolean"!=typeof i&&(i[e]??!1):"boolean"==typeof i?i:i[e]??!0};var d;u.log.time("wait until load"),await async function(e,t){L(e)&&(j(e)||q(e)?await oe(e,t):await Promise.all(["img","video"].flatMap((n=>Array.from(e.querySelectorAll(n)).map((e=>oe(e,t)))))))}(e,{timeout:u.timeout,onWarn:u.log.warn}),u.log.timeEnd("wait until load");const{width:m,height:f}=function(e,t){let{width:n,height:r}=t;if(I(e)&&(!n||!r)){const t=e.getBoundingClientRect();n=n||t.width||Number(e.getAttribute("width"))||0,r=r||t.height||Number(e.getAttribute("height"))||0}return{width:n,height:r}}(e,u);return u.width=m,u.height=f,u}(e,{...t,autoDestruct:!0})}function ce(e){if(!e)return;const t=e.createElement("style"),n=t.ownerDocument.createTextNode("\n.______background-clip--text {\n  background-clip: text;\n  -webkit-background-clip: text;\n}\n");return t.appendChild(n),t}function ue(e,t){if(e.ownerDocument)try{const t=e.toDataURL();if("data:,"!==t)return re(t,e.ownerDocument)}catch(e){t.log.warn("Failed to clone canvas",e)}const n=e.cloneNode(!1),r=e.getContext("2d"),o=n.getContext("2d");try{return r&&o&&o.putImageData(r.getImageData(0,0,e.width,e.height),0,0),n}catch(e){t.log.warn("Failed to clone canvas",e)}return n}const de=["width","height","-webkit-text-fill-color"],me=["stroke","fill"];function fe(e,t,n){const{defaultComputedStyles:r}=n,o=e.nodeName.toLowerCase(),a=_(e)&&"svg"!==o,i=a?me.map((t=>[t,e.getAttribute(t)])).filter((([,e])=>null!==e)):[],s=[a&&"svg",o,i.map(((e,t)=>`${e}=${t}`)).join(","),t].filter(Boolean).join(":");if(r.has(s))return r.get(s);const l=function(e){let t=e.sandbox;if(!t){const{ownerDocument:n}=e;try{n&&(t=n.createElement("iframe"),t.id=`__SANDBOX__-${ae()}`,t.width="0",t.height="0",t.style.visibility="hidden",t.style.position="fixed",n.body.appendChild(t),t.contentWindow?.document.write('<!DOCTYPE html><meta charset="UTF-8"><title></title><body>'),e.sandbox=t)}catch(t){e.log.warn("Failed to getSandBox",t)}}return t}(n),c=l?.contentWindow;if(!c)return new Map;const u=c?.document;let d,m;a?(d=u.createElementNS(te,"svg"),m=d.ownerDocument.createElementNS(d.namespaceURI,o),i.forEach((([e,t])=>{m.setAttributeNS(null,e,t)})),d.appendChild(m)):d=m=u.createElement(o),m.textContent=" ",u.body.appendChild(d);const f=c.getComputedStyle(m,t),g=new Map;for(let e=f.length,t=0;t<e;t++){const e=f.item(t);de.includes(e)||g.set(e,f.getPropertyValue(e))}return u.body.removeChild(d),r.set(s,g),g}function ge(e,t,n){const r=new Map,o=[],a=new Map;if(n)for(const e of n)i(e);else for(let t=e.length,n=0;n<t;n++)i(e.item(n));for(let e=o.length,t=0;t<e;t++)a.get(o[t])?.forEach(((e,t)=>r.set(t,e)));function i(n){const i=e.getPropertyValue(n),s=e.getPropertyPriority(n),l=n.lastIndexOf("-"),c=l>-1?n.substring(0,l):void 0;if(c){let e=a.get(c);e||(e=new Map,a.set(c,e)),e.set(n,[i,s])}(t.get(n)!==i||s)&&(c?o.push(c):r.set(n,[i,s]))}return r}const he=[":before",":after"],pe=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"],we=new Set(["symbol"]);async function ye(e,t,n,r,o){if(I(n)&&(V(n)||H(n)))return;if(r.filter&&!r.filter(n))return;we.has(t.nodeName)||we.has(n.nodeName)?r.currentParentNodeStyle=void 0:r.currentParentNodeStyle=r.currentNodeStyle;const a=await Se(n,r,!1,o);r.isEnable("restoreScrollPosition")&&function(e,t){if(!L(e)||!L(t))return;const{scrollTop:n,scrollLeft:r}=e;if(!n&&!r)return;const{transform:o}=t.style,a=new DOMMatrix(o),{a:i,b:s,c:l,d:c}=a;a.a=1,a.b=0,a.c=0,a.d=1,a.translateSelf(-r,-n),a.a=i,a.b=s,a.c=l,a.d=c,t.style.transform=a.toString()}(e,a),t.appendChild(a)}async function be(e,t,n,r){for(let o=(I(e)?e.shadowRoot?.firstChild:void 0)??e.firstChild;o;o=o.nextSibling)if(!U(o))if(I(o)&&Y(o)&&"function"==typeof o.assignedNodes){const a=o.assignedNodes();for(let o=0;o<a.length;o++)await ye(e,t,a[o],n,r)}else await ye(e,t,o,n,r)}const ve=/^[\w-:]+$/;async function Se(e,t,n=!1,r){const{ownerDocument:o,ownerWindow:a,fontFamilies:i}=t;if(o&&B(e))return r&&/\S/.test(e.data)&&r(e.data),o.createTextNode(e.data);if(o&&a&&I(e)&&(L(e)||_(e))){const r=await function(e,t){return W(e)?ue(e,t):G(e)?function(e,t){try{if(e?.contentDocument?.body)return Se(e.contentDocument.body,t)}catch(e){t.log.warn("Failed to clone iframe",e)}return e.cloneNode(!1)}(e,t):j(e)?function(e){const t=e.cloneNode(!1);return e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),"lazy"===t.loading&&(t.loading="eager"),t}(e):q(e)?async function(e,t){if(e.ownerDocument&&!e.currentSrc&&e.poster)return re(e.poster,e.ownerDocument);const n=e.cloneNode(!1);n.crossOrigin="anonymous",e.currentSrc&&e.currentSrc!==e.src&&(n.src=e.currentSrc);const r=n.ownerDocument;if(r){let o=!0;if(await oe(n,{onError:()=>o=!1,onWarn:t.log.warn}),!o)return e.poster?re(e.poster,e.ownerDocument):n;n.currentTime=e.currentTime,await new Promise((e=>{n.addEventListener("seeked",e,{once:!0})}));const a=r.createElement("canvas");a.width=e.offsetWidth,a.height=e.offsetHeight;try{const e=a.getContext("2d");e&&e.drawImage(n,0,0,a.width,a.height)}catch(r){return t.log.warn("Failed to clone video",r),e.poster?re(e.poster,e.ownerDocument):n}return ue(a,t)}return n}(e,t):e.cloneNode(!1)}(e,t);if(t.isEnable("removeAbnormalAttributes")){const e=r.getAttributeNames();for(let t=e.length,n=0;n<t;n++){const t=e[n];ve.test(t)||r.removeAttribute(t)}}const o=t.currentNodeStyle=function(e,t,n,r){const{ownerWindow:o,includeStyleProperties:a,currentParentNodeStyle:i}=r,s=t.style,l=o.getComputedStyle(e),c=fe(e,null,r);i?.forEach(((e,t)=>{c.delete(t)}));const u=ge(l,c,a);return u.delete("transition-property"),u.delete("all"),u.delete("d"),u.delete("content"),n&&(u.delete("margin-top"),u.delete("margin-right"),u.delete("margin-bottom"),u.delete("margin-left"),u.delete("margin-block-start"),u.delete("margin-block-end"),u.delete("margin-inline-start"),u.delete("margin-inline-end"),u.set("box-sizing",["border-box",""])),"text"===u.get("background-clip")?.[0]&&t.classList.add("______background-clip--text"),k&&(u.has("font-kerning")||u.set("font-kerning",["normal",""]),"hidden"!==u.get("overflow-x")?.[0]&&"hidden"!==u.get("overflow-y")?.[0]||"ellipsis"!==u.get("text-overflow")?.[0]||e.scrollWidth!==e.clientWidth||u.set("text-overflow",["clip",""])),u.forEach((([e,t],n)=>{s.setProperty(n,e,t)})),u}(e,r,n,t);n&&function(e,t){const{backgroundColor:n,width:r,height:o,style:a}=t,i=e.style;if(n&&i.setProperty("background-color",n,"important"),r&&i.setProperty("width",`${r}px`,"important"),o&&i.setProperty("height",`${o}px`,"important"),a)for(const e in a)i[e]=a[e]}(r,t);let a=!1;if(t.isEnable("copyScrollbar")){const t=[o.get("overflow-x")?.[0],o.get("overflow-y")?.[1]];a=t.includes("scroll")||(t.includes("auto")||t.includes("overlay"))&&(e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth)}const s=o.get("text-transform")?.[0],l=ie(o.get("font-family")?.[0]),c=l?e=>{"uppercase"===s?e=e.toUpperCase():"lowercase"===s?e=e.toLowerCase():"capitalize"===s&&(e=e[0].toUpperCase()+e.substring(1)),l.forEach((t=>{let n=i.get(t);n||i.set(t,n=new Set),e.split("").forEach((e=>n.add(e)))}))}:void 0;return function(e,t,n,r,o){const{ownerWindow:a,svgStyleElement:i,svgStyles:s,currentNodeStyle:l}=r;function c(n){const i=a.getComputedStyle(e,n);let c=i.getPropertyValue("content");if(!c||"none"===c)return;o?.(c),c=c.replace(/(')|(")|(counter\(.+\))/g,"");const u=[ae()],d=fe(e,n,r);l?.forEach(((e,t)=>{d.delete(t)}));const m=ge(i,d,r.includeStyleProperties);m.delete("content"),m.delete("-webkit-locale"),"text"===m.get("background-clip")?.[0]&&t.classList.add("______background-clip--text");const f=[`content: '${c}';`];if(m.forEach((([e,t],n)=>{f.push(`${n}: ${e}${t?" !important":""};`)})),1===f.length)return;try{t.className=[t.className,...u].join(" ")}catch(e){return void r.log.warn("Failed to copyPseudoClass",e)}const g=f.join("\n  ");let h=s.get(g);h||(h=[],s.set(g,h)),h.push(`.${u[0]}:${n}`)}i&&a&&(he.forEach(c),n&&pe.forEach(c))}(e,r,a,t,c),function(e,t){O(e)&&(t.innerHTML=e.value),(O(e)||z(e)||X(e))&&t.setAttribute("value",e.value)}(e,r),q(e)||await be(e,r,t,c),r}const s=e.cloneNode(!1);return await be(e,s,t),s}function Ce(e,t){const{url:n,requestType:r="text",responseType:o="text",imageDom:a}=t;let i=n;const{timeout:s,acceptOfImage:l,requests:c,fetchFn:u,fetch:{requestInit:d,bypassingCache:m,placeholderImage:f},font:g,workers:h,fontFamilies:p}=e;"image"===r&&(D||T)&&e.drawImageCount++;let w=c.get(n);if(!w){m&&m instanceof RegExp&&m.test(i)&&(i+=(/\?/.test(i)?"&":"?")+(new Date).getTime());const t=r.startsWith("font")&&g&&g.minify,y=new Set;t&&r.split(";")[1].split(",").forEach((e=>{p.has(e)&&p.get(e).forEach((e=>y.add(e)))}));const b=t&&y.size,v={url:i,timeout:s,responseType:b?"arrayBuffer":o,headers:"image"===r?{accept:l}:void 0,...d};w={type:r,resolve:void 0,reject:void 0,response:null},w.response=(async()=>{if(u&&"image"===r){const e=await u(n);if(e)return e}return!D&&n.startsWith("http")&&h.length?new Promise(((e,t)=>{h[c.size&h.length-1].postMessage({rawUrl:n,...v}),w.resolve=e,w.reject=t})):function(e){const{url:t,timeout:n,responseType:r,...o}=e,a=new AbortController,i=n?setTimeout((()=>a.abort()),n):void 0;return fetch(t,{signal:a.signal,...o}).then((e=>{if(!e.ok)throw new Error("Failed fetch, not 2xx response",{cause:e});switch(r){case"arrayBuffer":return e.arrayBuffer();case"dataUrl":return e.blob().then(ne);default:return e.text()}})).finally((()=>clearTimeout(i)))}(v)})().catch((t=>{if(c.delete(n),"image"===r&&f)return e.log.warn("Failed to fetch image base64, trying to use placeholder image",i),"string"==typeof f?f:f(a);throw t})),c.set(n,w)}return w.response}async function Ee(e,t,n,r){if(!Ae(e))return e;for(const[o,a]of function(e,t){const n=[];return e.replace(xe,((e,r,o)=>(n.push([o,Z(o,t)]),e))),n.filter((([e])=>!Q(e)))}(e,t))try{const t=await Ce(n,{url:a,requestType:r?"image":"text",responseType:"dataUrl"});e=e.replace(Ne(o),`$1${t}$3`)}catch(e){n.log.warn("Failed to fetch css data url",o,e)}return e}function Ae(e){return/url\((['"]?)([^'"]+?)\1\)/.test(e)}const xe=/url\((['"]?)([^'"]+?)\1\)/g;function Ne(e){const t=e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${t})(['"]?\\))`,"g")}const ke=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function De(e,t){const{tasks:n}=t;I(e)&&((j(e)||R(e))&&n.push(...function(e,t){if(j(e)){const n=e.currentSrc||e.src;if(!Q(n))return[Ce(t,{url:n,imageDom:e,requestType:"image",responseType:"dataUrl"}).then((t=>{t&&(e.srcset="",e.dataset.originalSrc=n,e.src=t||"")}))];(D||T)&&t.drawImageCount++}else if(_(e)&&!Q(e.href.baseVal)){const n=e.href.baseVal;return[Ce(t,{url:n,imageDom:e,requestType:"image",responseType:"dataUrl"}).then((t=>{t&&(e.dataset.originalSrc=n,e.href.baseVal=t||"")}))]}return[]}(e,t)),M(e)&&n.push(...function(e,t){const{ownerDocument:n,svgDefsElement:r}=t,o=e.getAttribute("href")??e.getAttribute("xlink:href");if(!o)return[];const[a,i]=o.split("#");if(i){const o=`#${i}`,s=n?.querySelector(`svg ${o}`);if(a&&e.setAttribute("href",o),r?.querySelector(o))return[];if(s)return r?.appendChild(s.cloneNode(!0)),[];if(a)return[Ce(t,{url:a,responseType:"text"}).then((e=>{r?.insertAdjacentHTML("beforeend",e)}))]}return[]}(e,t))),L(e)&&n.push(...function(e,t){return ke.map((n=>{const r=e.getPropertyValue(n);return r&&"none"!==r?((D||T)&&t.drawImageCount++,Ee(r,null,t,!0).then((t=>{t&&r!==t&&e.setProperty(n,t,e.getPropertyPriority(n))}))):null})).filter(Boolean)}(e.style,t)),e.childNodes.forEach((e=>{De(e,t)}))}const Te=/(\/\*[\s\S]*?\*\/)/g,Pe=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi,Fe=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,$e=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function Ie(e,t){const{font:n}=t,r=n?n?.preferredFormat:void 0;return r?e.replace($e,(e=>{for(;;){const[t,,n]=Fe.exec(e)||[];if(!n)return"";if(n===r)return`src: ${t};`}})):e}async function _e(e,t){const n=await le(e,t);if(I(n.node)&&_(n.node))return n.node;const{ownerDocument:r,log:o,tasks:a,svgStyleElement:i,svgDefsElement:s,svgStyles:l,font:c,progress:u,autoDestruct:d,onCloneNode:m,onEmbedNode:f,onCreateForeignObjectSvg:g}=n;o.time("clone node");const h=await Se(n.node,n,!0);if(i&&r){let e="";l.forEach(((t,n)=>{e+=`${t.join(",\n")} {\n  ${n}\n}\n`})),i.appendChild(r.createTextNode(e))}o.timeEnd("clone node"),await(m?.(h)),!1!==c&&I(h)&&(o.time("embed web font"),await async function(e,t){const{ownerDocument:n,svgStyleElement:r,fontFamilies:o,fontCssTexts:a,tasks:i,font:s}=t;if(n&&r&&o.size)if(s&&s.cssText){const e=Ie(s.cssText,t);r.appendChild(n.createTextNode(`${e}\n`))}else{const e=Array.from(n.styleSheets).filter((e=>{try{return"cssRules"in e&&Boolean(e.cssRules.length)}catch(n){return t.log.warn(`Error while reading CSS rules from ${e.href}`,n),!1}}));await Promise.all(e.flatMap((e=>Array.from(e.cssRules).map((async(n,r)=>{if($(n)){let o=r+1;const a=n.href;let i="";try{i=await Ce(t,{url:a,requestType:"text",responseType:"text"})}catch(e){t.log.warn(`Error fetch remote css import from ${a}`,e)}const s=i.replace(xe,((e,t,n)=>e.replace(n,Z(n,a))));for(const n of function(e){if(null==e)return[];const t=[];let n=e.replace(Te,"");for(;;){const e=Pe.exec(n);if(!e)break;t.push(e[0])}n=n.replace(Pe,"");const r=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,o=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let e=r.exec(n);if(e)o.lastIndex=r.lastIndex;else{if(e=o.exec(n),!e)break;r.lastIndex=o.lastIndex}t.push(e[0])}return t}(s))try{e.insertRule(n,n.startsWith("@import")?o+=1:e.cssRules.length)}catch(e){t.log.warn("Error inserting rule from remote css import",{rule:n,error:e})}}}))))),e.flatMap((e=>Array.from(e.cssRules))).filter((e=>F(e)&&Ae(e.style.getPropertyValue("src"))&&ie(e.style.getPropertyValue("font-family"))?.some((e=>o.has(e))))).forEach((e=>{const o=e,s=a.get(o.cssText);s?r.appendChild(n.createTextNode(`${s}\n`)):i.push(Ee(o.cssText,o.parentStyleSheet?o.parentStyleSheet.href:null,t).then((e=>{e=Ie(e,t),a.set(o.cssText,e),r.appendChild(n.createTextNode(`${e}\n`))})))}))}}(0,n),o.timeEnd("embed web font")),o.time("embed node"),De(h,n);const p=a.length;let w=0;u?.(w,p),await Promise.all([...Array.from({length:4})].map((async()=>{for(;;){const e=a.pop();if(!e)break;try{await e}catch(e){n.log.warn("Failed to run task",e)}u?.(++w,p)}}))),o.timeEnd("embed node"),await(f?.(h));const y=function(e,t){const{width:n,height:r}=t,o=function(e,t,n){const r=ee(n).createElementNS(te,"svg");return r.setAttributeNS(null,"width",e.toString()),r.setAttributeNS(null,"height",t.toString()),r.setAttributeNS(null,"viewBox",`0 0 ${e} ${t}`),r}(n,r,e.ownerDocument),a=o.ownerDocument.createElementNS(o.namespaceURI,"foreignObject");return a.setAttributeNS(null,"x","0%"),a.setAttributeNS(null,"y","0%"),a.setAttributeNS(null,"width","100%"),a.setAttributeNS(null,"height","100%"),a.append(e),o.appendChild(a),o}(h,n);return s&&y.insertBefore(s,y.children[0]),i&&y.insertBefore(i,y.children[0]),d&&function(e){if(e.ownerDocument=void 0,e.ownerWindow=void 0,e.svgStyleElement=void 0,e.svgDefsElement=void 0,e.svgStyles.clear(),e.defaultComputedStyles.clear(),e.sandbox){try{e.sandbox.remove()}catch(t){e.log.warn("Failed to destroyContext",t)}e.sandbox=void 0}e.workers=[],e.fontFamilies.clear(),e.fontCssTexts.clear(),e.requests.clear(),e.tasks=[]}(n),await(g?.(y)),y}async function Re(e,t){const n=await le(e,t),r=await _e(n),o=function(e,t){let n=(new XMLSerializer).serializeToString(e);return t&&(n=n.replace(/[\u0000-\u0008\v\f\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/gu,"")),`data:image/svg+xml;charset=utf-8,${encodeURIComponent(n)}`}(r,n.isEnable("removeControlCharacter"));n.autoDestruct||(n.svgStyleElement=ce(n.ownerDocument),n.svgDefsElement=n.ownerDocument?.createElementNS(te,"defs"),n.svgStyles.clear());const a=re(o,r.ownerDocument);return await async function(e,t){const{log:n,timeout:r,drawImageCount:o,drawImageInterval:a}=t;n.time("image to canvas");const i=await oe(e,{timeout:r,onWarn:t.log.warn}),{canvas:s,context2d:l}=function(e,t){const{width:n,height:r,scale:o,backgroundColor:a,maximumCanvasSize:i}=t,s=e.createElement("canvas");s.width=Math.floor(n*o),s.height=Math.floor(r*o),s.style.width=`${n}px`,s.style.height=`${r}px`,i&&(s.width>i||s.height>i)&&(s.width>i&&s.height>i?s.width>s.height?(s.height*=i/s.width,s.width=i):(s.width*=i/s.height,s.height=i):s.width>i?(s.height*=i/s.width,s.width=i):(s.width*=i/s.height,s.height=i));const l=s.getContext("2d");return l&&a&&(l.fillStyle=a,l.fillRect(0,0,s.width,s.height)),{canvas:s,context2d:l}}(e.ownerDocument,t),c=()=>{try{l?.drawImage(i,0,0,s.width,s.height)}catch(e){t.log.warn("Failed to drawImage",e)}};if(c(),t.isEnable("fixSvgXmlDecode"))for(let e=0;e<o;e++)await new Promise((t=>{setTimeout((()=>{c(),t()}),e+a)}));return t.drawImageCount=0,n.timeEnd("image to canvas"),s}(a,n)}async function Me(e,t){return async function(e,t){const n=await le(e,t),{log:r,quality:o,type:a,dpi:i}=n,s=await Re(n);r.time("canvas to data url");let l=s.toDataURL(a,o);if(["image/png","image/jpeg"].includes(a)&&i&&A&&x){const[e,t]=l.split(",");let n=0,r=!1;if("image/png"===a){const e=function(e){let t=e.indexOf(y);return-1===t&&(t=e.indexOf(b)),-1===t&&(t=e.indexOf(v)),t}(t);e>=0?(n=4*Math.ceil((e+28)/3),r=!0):n=44}else"image/jpeg"===a&&(n=24);const o=t.substring(0,n),s=t.substring(n),c=window.atob(o),u=new Uint8Array(c.length);for(let e=0;e<u.length;e++)u[e]=c.charCodeAt(e);const d="image/png"===a?w(u,i,r):function(e,t){return e[13]=1,e[14]=t>>8,e[15]=255&t,e[16]=t>>8,e[17]=255&t,e}(u,i);l=[e,",",window.btoa(String.fromCharCode(...d)),s].join("")}return r.timeEnd("canvas to data url"),l}(await le(e,{...t,type:"image/jpeg"}))}r().initializers.add("tohsakarat-postCamera",(function(){function e(e){var t=e.split("/d/");if(2===t.length){var n=t[1].split("-");if(n.length>1)return t[0]+"/d/"+n[0]}return e}window.canSave=!0,(0,o.extend)(l(),"userControls",(function(t,n){var o=this,a=r().forum.attribute("baseUrl")+r().route.post(n);t.add("screen-shot",u().component({disable:!canSave,icon:"fas fa-camera",class:canSave?"":"disabled",onclick:function(){var t,i;if(canSave){window.cameraCurProgress="⏳⏳⏳",window.canSave=!1,console.log("======保存截图======"),console.log(o);var s=document.querySelector('.PostStream-item[data-id="'+n.data.id+'"] '),l=document.createElement("div");l.className="temp-screenShot-box";var c=document.createElement("div");c.className="temp-screenShot-outer-box";var u=s.cloneNode(!0);u.className+=" temp-screenShot",document.createElement("div").className="coverAll coverPaper";var d=document.createElement("div");d.className="temp-screenShot-info",d.innerHTML="<b class='from'> 👉  </b>"+e(a)+" "+r().forum.data.attributes.title+"<br / >"+(null!=r()&&null!=(t=r().session)&&null!=(t=t.user)&&null!=(t=t.data)&&t.morseCode?null==r()||null==(i=r().session)||null==(i=i.user)||null==(i=i.data)?void 0:i.morseCode:""),l.appendChild(d),l.appendChild(u),c.appendChild(l),s.appendChild(c),l.querySelectorAll("img[loading='lazy']").forEach((function(e){e.removeAttribute("loading"),e.removeAttribute("importance")}));for(var f=l.querySelectorAll(".Dropdown-menu,.Reactions--Ul,.CommentPost--Reactions"),g=0;g<f.length;++g)f[g].parentNode.removeChild(f[g]);setTimeout((function(){Me(l,{quality:.8,scale:2,debug:!0,workerNumber:16,timeout:3e3,progress:function(e,t){window.canSave=!1,m.redraw(),console.log(e+"/"+t),window.cameraCurProgress=e+"/"+t},features:{fixSvgXmlDecode:!0}}).then((function(e){var t=document.createElement("a");t.download="screenShot"+r().forum.data.attributes.title+r().route.post(n)+".jpeg",t.href=e,t.click(),window.canSave=!0,m.redraw(),s.removeChild(c)}))}),100)}else m.redraw()}},window.canSave?r().translator.trans("tohsakarat-post-camera.lib.scan-post"):window.cameraCurProgress))})),(0,o.extend)(i(),"userControls",(function(t,n){var o=this,a=r().forum.attribute("baseUrl")+r().route.discussion(n);t.add("screen-shot",u().component({disable:!canSave,icon:"fas fa-camera",class:canSave?"":"disabled",onclick:function(){var t,n;if(canSave){window.cameraCurProgress="⏳⏳⏳",window.canSave=!1,console.log("======保存截图======"),console.log(o);var i=document.querySelector(".DiscussionPage-discussion"),s=document.createElement("div");s.className="temp-screenShot-box";var l=document.createElement("div");l.className="temp-screenShot-outer-box";var c=i.cloneNode(!0);c.className+=" temp-screenShot";var u=document.createElement("div");u.className="coverAll";var d=document.createElement("div");d.className="temp-screenShot-info",d.innerHTML="<b class='from'> 👉  </b>"+e(a)+" "+r().forum.data.attributes.title+"<br / >"+(null!=r()&&null!=(t=r().session)&&null!=(t=t.user)&&null!=(t=t.data)&&t.morseCode?null==r()||null==(n=r().session)||null==(n=n.user)||null==(n=n.data)?void 0:n.morseCode:""),s.appendChild(u),s.appendChild(d),s.appendChild(c),l.appendChild(s),i.appendChild(l),s.querySelectorAll("img[loading='lazy']").forEach((function(e){e.removeAttribute("loading"),e.removeAttribute("importance")}));for(var f=s.querySelectorAll(".Dropdown-menu,.Reactions--Ul,.CommentPost--Reactions"),g=0;g<f.length;++g)f[g].parentNode.removeChild(f[g]);setTimeout((function(){Me(s,{quality:.8,scale:2,debug:!0,workerNumber:16,timeout:3e3,progress:function(e,t){window.canSave=!1,m.redraw(),console.log(e+"/"+t),window.cameraCurProgress=e+"/"+t},features:{fixSvgXmlDecode:!0}}).then((function(e){var t=document.createElement("a");t.download="screenShot"+r().forum.data.attributes.title+".jpeg",t.href=e,t.click(),window.canSave=!0,m.redraw(),i.removeChild(l)}))}),100)}else m.redraw()}},window.canSave?r().translator.trans("tohsakarat-post-camera.lib.scan-post"):window.cameraCurProgress))}))}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map